// chronoï¼š ç”¨äºå¤„ç†æ—¥æœŸæ—¶é—´ï¼Œæä¾›UTCæ—¶é—´æˆ³åŠŸèƒ½
use chrono::{DateTime, Utc};
// serde: ç”¨äºåºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼Œè®©ç»“æ„ä½“å¯ä»¥è½¬æ¢ä¸ºJSONç­‰æ ¼å¼
use serde::{Deserialize, Serialize};
// sha2: æä¾›SHA-256å“ˆå¸Œç®—æ³•å®ç°
use sha2::{Digest,Sha256};
// std::fmt: ç”¨äºè‡ªå®šä¹‰æ˜¾ç¤ºæ ¼å¼
use std::fmt::{self, format};


/// # åŒºå—ç»“æ„ä½“ (Block Structure)
/// 
/// åŒºå—æ˜¯åŒºå—é“¾çš„åŸºæœ¬ç»„æˆå•ä½ï¼Œæ¯ä¸ªåŒºå—åŒ…å«ä»¥ä¸‹æ ¸å¿ƒä¿¡æ¯ï¼š
/// - åŒºå—ç´¢å¼•ï¼šæ ‡è¯†åŒºå—åœ¨é“¾ä¸­çš„ä½ç½®
/// - æ—¶é—´æˆ³ï¼šè®°å½•åŒºå—åˆ›å»ºæ—¶é—´
/// - æ•°æ®ï¼šå­˜å‚¨åœ¨åŒºå—ä¸­çš„å®é™…ä¿¡æ¯
/// - å‰ä¸€åŒºå—å“ˆå¸Œï¼šè¿æ¥åˆ°å‰ä¸€ä¸ªåŒºå—ï¼Œå½¢æˆé“¾å¼ç»“æ„
/// - å½“å‰å“ˆå¸Œï¼šå½“å‰åŒºå—çš„å”¯ä¸€æ ‡è¯†
/// - Nonceï¼šæŒ–çŸ¿è¿‡ç¨‹ä¸­çš„éšæœºæ•°ï¼Œç”¨äºå·¥ä½œé‡è¯æ˜
/// - éš¾åº¦ï¼šæ§åˆ¶æŒ–çŸ¿çš„å›°éš¾ç¨‹åº¦
/// 
/// ## ä¸ºä»€ä¹ˆéœ€è¦è¿™äº›å­—æ®µï¼Ÿ
/// - `index`: å¸®åŠ©ç¡®å®šåŒºå—çš„é¡ºåºï¼Œé˜²æ­¢é‡å¤æˆ–é—æ¼
/// - `timestamp`: è®°å½•äº¤æ˜“æ—¶é—´ï¼Œå…·æœ‰æ³•å¾‹æ„ä¹‰
/// - `data`: å®é™…å­˜å‚¨çš„ä¿¡æ¯ï¼Œå¯ä»¥æ˜¯äº¤æ˜“è®°å½•ã€åˆçº¦ç­‰
/// - `previous_hash`: å°†åŒºå—è¿æ¥èµ·æ¥ï¼Œä»»ä½•ç¯¡æ”¹éƒ½ä¼šè¢«å‘ç°
/// - `hash`: åŒºå—çš„"æŒ‡çº¹"ï¼Œç”¨äºå¿«é€ŸéªŒè¯å®Œæ•´æ€§
/// - `nonce`: æŒ–çŸ¿çš„å…³é”®ï¼Œé€šè¿‡è°ƒæ•´è¿™ä¸ªå€¼æ¥æ»¡è¶³éš¾åº¦è¦æ±‚
/// - `difficulty`: æ§åˆ¶ç½‘ç»œçš„å‡ºå—é€Ÿåº¦å’Œå®‰å…¨æ€§
#[derive(Serialize, Deserialize, Debug, Clone, PartialEq)]
pub struct Block {
    /// åŒºå—ç´¢å¼• - ä»0å¼€å§‹çš„è¿ç»­ç¼–å·
    /// åˆ›ä¸–åŒºå—çš„ç´¢å¼•ä¸º0ï¼Œåç»­åŒºå—ä¾æ¬¡é€’å¢
    pub index: u64,
    
    /// åŒºå—åˆ›å»ºæ—¶é—´æˆ³ - ä½¿ç”¨UTCæ—¶é—´
    /// è®°å½•åŒºå—è¢«åˆ›å»ºçš„å‡†ç¡®æ—¶é—´ï¼Œç”¨äºæ’åºå’ŒéªŒè¯
    pub timestamp: DateTime<Utc>,
    
    /// åŒºå—åŒ…å«çš„æ•°æ® - å®é™…å­˜å‚¨çš„ä¿¡æ¯
    /// åœ¨çœŸå®çš„åŒºå—é“¾ä¸­ï¼Œè¿™é‡Œé€šå¸¸å­˜å‚¨äº¤æ˜“è®°å½•ã€æ™ºèƒ½åˆçº¦ç­‰
    pub data: String,
    
    /// å‰ä¸€ä¸ªåŒºå—çš„å“ˆå¸Œå€¼ - å½¢æˆé“¾å¼ç»“æ„çš„å…³é”®
    /// é€šè¿‡è¿™ä¸ªå­—æ®µï¼ŒåŒºå—ä¹‹é—´å½¢æˆä¸å¯ç¯¡æ”¹çš„é“¾æ¡
    /// å¦‚æœæœ‰äººè¯•å›¾ä¿®æ”¹å†å²åŒºå—ï¼Œè¿™ä¸ªå“ˆå¸Œå€¼å°±ä¼šå¯¹ä¸ä¸Š
    pub previous_hash: String,
    
    /// å½“å‰åŒºå—çš„å“ˆå¸Œå€¼ - åŒºå—çš„å”¯ä¸€æ ‡è¯†ç¬¦
    /// åŸºäºåŒºå—çš„æ‰€æœ‰ä¿¡æ¯è®¡ç®—å¾—å‡ºï¼Œä»»ä½•å¾®å°æ”¹åŠ¨éƒ½ä¼šå¯¼è‡´å“ˆå¸Œå€¼å®Œå…¨ä¸åŒ
    pub hash: String,
    
    /// æŒ–çŸ¿éšæœºæ•° - å·¥ä½œé‡è¯æ˜çš„æ ¸å¿ƒ
    /// çŸ¿å·¥é€šè¿‡ä¸æ–­è°ƒæ•´è¿™ä¸ªå€¼æ¥å¯»æ‰¾æ»¡è¶³éš¾åº¦è¦æ±‚çš„å“ˆå¸Œå€¼
    pub nonce: u64,
    
    /// æŒ–çŸ¿éš¾åº¦ - æ§åˆ¶æŒ–çŸ¿çš„å›°éš¾ç¨‹åº¦
    /// æ•°å€¼è¶Šå¤§ï¼Œæ‰¾åˆ°æœ‰æ•ˆå“ˆå¸Œå€¼å°±è¶Šå›°éš¾ï¼ŒæŒ–çŸ¿æ—¶é—´è¶Šé•¿
    pub difficulty: u32,
}


impl Block {
    /// # åˆ›å»ºæ–°åŒºå—
    /// 
    /// è¿™ä¸ªæ–¹æ³•ç”¨äºåˆ›å»ºä¸€ä¸ªæ–°çš„åŒºå—ï¼Œä½†è¿˜æ²¡æœ‰è¿›è¡ŒæŒ–çŸ¿
    /// åˆ›å»ºåéœ€è¦è°ƒç”¨ mine_block() æ–¹æ³•æ¥å®Œæˆå·¥ä½œé‡è¯æ˜
    /// 
    /// ## å‚æ•°è¯´æ˜
    /// * `index` - åŒºå—ç´¢å¼•ï¼Œé€šå¸¸æ˜¯å‰ä¸€ä¸ªåŒºå—çš„ç´¢å¼•+1
    /// * `data` - è¦å­˜å‚¨åœ¨åŒºå—ä¸­çš„æ•°æ®
    /// * `previous_hash` - å‰ä¸€ä¸ªåŒºå—çš„å“ˆå¸Œå€¼ï¼Œç”¨äºå»ºç«‹é“¾æ¥
    /// * `difficulty` - æŒ–çŸ¿éš¾åº¦ï¼Œå†³å®šéœ€è¦å¤šå°‘ä¸ªå‰å¯¼é›¶
    /// 
    /// ## è¿”å›å€¼
    /// è¿”å›ä¸€ä¸ªæ–°åˆ›å»ºçš„åŒºå—å®ä¾‹ï¼Œhashå­—æ®µå·²ç»è®¡ç®—ä½†å¯èƒ½ä¸æ»¡è¶³éš¾åº¦è¦æ±‚
    pub fn new(index: u64, data: String, previous_hash: String, difficulty: u32) -> Self {
        // è·å–å½“å‰UTCæ—¶é—´ä½œä¸ºåŒºå—åˆ›å»ºæ—¶é—´
        let timestamp = Utc::now();

        // åˆ›å»ºåŒºå—å®ä¾‹ï¼Œåˆå§‹æ—¶nonceä¸º0ï¼Œhashä¸ºç©º
        let mut  block = Block {
            index,
            timestamp,
            data,
            previous_hash,
            hash: String::new(), //åˆå§‹åŒ–ä¸ºç©ºï¼Œç¨åè®¡ç®—
            nonce:0,    //ä»0å¼€å§‹ï¼ŒæŒ–çŸ¿æ—¶ä¼šé€’å¢
            difficulty,
        };

        // è®¡ç®—åˆå§‹å“ˆå¸Œå€¼ï¼ˆä½†å¯èƒ½ä¸æ»¡è¶³éš¾åº¦è¦æ±‚ï¼‰
        // è¿™ä¸ªå“ˆå¸Œå€¼åŸºäºåŒºå—çš„æ‰€æœ‰ä¿¡æ¯ï¼ŒåŒ…æ‹¬nonce=0
        block.hash = block.calculate_hash();
        block
    }

    /// # åˆ›å»ºåˆ›ä¸–åŒºå—ï¼ˆGenesis Blockï¼‰
    /// 
    /// åˆ›ä¸–åŒºå—æ˜¯åŒºå—é“¾çš„ç¬¬ä¸€ä¸ªåŒºå—ï¼Œå…·æœ‰ç‰¹æ®Šæ€§ï¼š
    /// - ç´¢å¼•å›ºå®šä¸º0
    /// - æ²¡æœ‰å‰ä¸€ä¸ªåŒºå—ï¼Œæ‰€ä»¥previous_hashè®¾ä¸º"0"
    /// - åŒ…å«ç‰¹æ®Šçš„åˆ›ä¸–ä¿¡æ¯
    /// - é€šå¸¸éš¾åº¦è¾ƒä½ï¼Œä¾¿äºå¿«é€Ÿç”Ÿæˆ
    /// 
    /// ## ä¸ºä»€ä¹ˆéœ€è¦åˆ›ä¸–åŒºå—ï¼Ÿ
    /// åŒºå—é“¾éœ€è¦ä¸€ä¸ªèµ·ç‚¹ï¼Œåˆ›ä¸–åŒºå—å°±æ˜¯è¿™ä¸ªèµ·ç‚¹
    /// æ‰€æœ‰åç»­åŒºå—éƒ½ç›´æ¥æˆ–é—´æ¥åœ°è¿æ¥åˆ°åˆ›ä¸–åŒºå—
    pub fn genesis_block() -> Self {
        Block::new(
            0,                                          // åˆ›ä¸–åŒºå—ç´¢å¼•å›ºå®šä¸º0
            "åˆ›ä¸–åŒºå— - Genesis Block".to_string(),      // åˆ›ä¸–åŒºå—çš„æ ‡è¯†ä¿¡æ¯
            "0".to_string(),                           // æ²¡æœ‰å‰ç½®åŒºå—ï¼Œç”¨"0"è¡¨ç¤º
            1,                                         // è¾ƒä½éš¾åº¦ï¼Œä¾¿äºå¿«é€Ÿç”Ÿæˆ     
        )
    }

    /// # è®¡ç®—åŒºå—çš„å“ˆå¸Œå€¼
    /// 
    /// ä½¿ç”¨SHA-256ç®—æ³•è®¡ç®—åŒºå—çš„å“ˆå¸Œå€¼ã€‚è¿™ä¸ªå“ˆå¸Œå€¼æ˜¯åŒºå—çš„"æŒ‡çº¹"ï¼Œ
    /// åŸºäºåŒºå—çš„æ‰€æœ‰é‡è¦ä¿¡æ¯è®¡ç®—å¾—å‡ºã€‚å¦‚æœåŒºå—çš„ä»»ä½•ä¿¡æ¯å‘ç”Ÿå˜åŒ–ï¼Œ
    /// å“ˆå¸Œå€¼å°±ä¼šå®Œå…¨ä¸åŒã€‚
    /// 
    /// ## SHA-256ç®—æ³•ç‰¹ç‚¹
    /// - è¾“å‡ºå›ºå®šä¸º256ä½ï¼ˆ64ä¸ªåå…­è¿›åˆ¶å­—ç¬¦ï¼‰
    /// - å•å‘å‡½æ•°ï¼šå¾ˆéš¾ä»å“ˆå¸Œå€¼æ¨ç®—å‡ºåŸå§‹æ•°æ®
    /// - é›ªå´©æ•ˆåº”ï¼šè¾“å…¥çš„å¾®å°å˜åŒ–ä¼šå¯¼è‡´è¾“å‡ºçš„å·¨å¤§å˜åŒ–
    /// - æŠ—ç¢°æ’ï¼šå¾ˆéš¾æ‰¾åˆ°ä¸¤ä¸ªä¸åŒçš„è¾“å…¥äº§ç”Ÿç›¸åŒçš„å“ˆå¸Œå€¼
    /// 
    /// ## å“ˆå¸Œè®¡ç®—åŒ…å«çš„å­—æ®µ
    /// æŒ‰é¡ºåºè¿æ¥ä»¥ä¸‹å­—æ®µåè¿›è¡Œå“ˆå¸Œè®¡ç®—ï¼š
    /// 1. index - åŒºå—ç´¢å¼•
    /// 2. timestamp - æ—¶é—´æˆ³ï¼ˆè½¬æ¢ä¸ºUnixæ—¶é—´æˆ³ï¼‰
    /// 3. data - åŒºå—æ•°æ®
    /// 4. previous_hash - å‰ä¸€åŒºå—å“ˆå¸Œ
    /// 5. nonce - éšæœºæ•°
    /// 6. difficulty - éš¾åº¦å€¼
    pub fn calculate_hash(&self) -> String {
        // å°†åŒºå—çš„å…³é”®ä¿¡æ¯æŒ‰é¡ºåºè¿æ¥æˆä¸€ä¸ªå­—ç¬¦ä¸²
        // timestamp.timestamp() å°†DateTimeè½¬æ¢ä¸ºUnixæ—¶é—´æˆ³
        let data = format!(
            "{}{}{}{}{}{}",
            self.index,                          // åŒºå—ç´¢å¼•
            self.timestamp.timestamp(),          // Unixæ—¶é—´æˆ³
            self.data,                          // åŒºå—æ•°æ®
            self.previous_hash,                 // å‰ä¸€åŒºå—å“ˆå¸Œ
            self.nonce,                         // å½“å‰nonceå€¼
            self.difficulty                     // éš¾åº¦å€¼
        );
        
        // åˆ›å»ºSHA-256å“ˆå¸Œå™¨
        let mut hasher = Sha256::new();
        // å°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºå­—èŠ‚æ•°ç»„å¹¶è¾“å…¥å“ˆå¸Œå™¨
        hasher.update(data.as_bytes());
        // è®¡ç®—å“ˆå¸Œå€¼å¹¶è½¬æ¢ä¸ºåå…­è¿›åˆ¶å­—ç¬¦ä¸²
        format!("{:x}", hasher.finalize())
    }

    
    /// # æŒ–çŸ¿ - å·¥ä½œé‡è¯æ˜ç®—æ³•ï¼ˆProof of Workï¼‰
    /// 
    /// è¿™æ˜¯åŒºå—é“¾å®‰å…¨çš„æ ¸å¿ƒæœºåˆ¶ã€‚æŒ–çŸ¿çš„ç›®æ ‡æ˜¯æ‰¾åˆ°ä¸€ä¸ªnonceå€¼ï¼Œ
    /// ä½¿å¾—åŒºå—çš„å“ˆå¸Œå€¼æ»¡è¶³éš¾åº¦è¦æ±‚ï¼ˆä»¥æŒ‡å®šæ•°é‡çš„0å¼€å¤´ï¼‰ã€‚
    /// 
    /// ## å·¥ä½œé‡è¯æ˜çš„åŸç†
    /// 1. è®¾å®šéš¾åº¦ï¼ˆéœ€è¦å¤šå°‘ä¸ªå‰å¯¼é›¶ï¼‰
    /// 2. ä»nonce=0å¼€å§‹å°è¯•
    /// 3. è®¡ç®—å½“å‰åŒºå—çš„å“ˆå¸Œå€¼
    /// 4. æ£€æŸ¥å“ˆå¸Œå€¼æ˜¯å¦æ»¡è¶³éš¾åº¦è¦æ±‚
    /// 5. å¦‚æœä¸æ»¡è¶³ï¼Œnonce+1ï¼Œé‡å¤æ­¥éª¤3-4
    /// 6. ç›´åˆ°æ‰¾åˆ°æ»¡è¶³è¦æ±‚çš„å“ˆå¸Œå€¼
    /// 
    /// ## ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ
    /// - **è®¡ç®—å›°éš¾ï¼ŒéªŒè¯ç®€å•**ï¼šæ‰¾åˆ°æ­£ç¡®ç­”æ¡ˆéœ€è¦å¤§é‡è®¡ç®—ï¼Œä½†éªŒè¯åªéœ€ä¸€æ¬¡å“ˆå¸Œ
    /// - **æ— æ³•é¢„æµ‹**ï¼šæ— æ³•é¢„çŸ¥å“ªä¸ªnonceå€¼ä¼šäº§ç”Ÿæœ‰æ•ˆå“ˆå¸Œï¼Œåªèƒ½æš´åŠ›å°è¯•
    /// - **è‡ªåŠ¨è°ƒèŠ‚**ï¼šé€šè¿‡è°ƒæ•´éš¾åº¦æ¥æ§åˆ¶å‡ºå—æ—¶é—´
    /// 
    /// ## å®‰å…¨æ€§ä¿è¯
    /// - æ”»å‡»è€…è¦ä¿®æ”¹å†å²åŒºå—ï¼Œéœ€è¦é‡æ–°æŒ–æ˜è¯¥åŒºå—åŠä¹‹åçš„æ‰€æœ‰åŒºå—
    /// - åªè¦è¯šå®èŠ‚ç‚¹æ§åˆ¶å¤§éƒ¨åˆ†ç®—åŠ›ï¼Œç½‘ç»œå°±æ˜¯å®‰å…¨çš„
    pub fn mine_block(&mut self) {
        // æ ¹æ®éš¾åº¦ç”Ÿæˆç›®æ ‡å­—ç¬¦ä¸²ï¼Œä¾‹å¦‚éš¾åº¦ä¸º3åˆ™target="000"
        let target = "0".repeat(self.difficulty as usize);
        
        // è®°å½•æŒ–çŸ¿å¼€å§‹æ—¶é—´ï¼Œç”¨äºè®¡ç®—æŒ–çŸ¿ç”¨æ—¶å’Œå“ˆå¸Œç‡
        let start_time = std::time::Instant::now();
        
        // è®°å½•å°è¯•çš„å“ˆå¸Œæ¬¡æ•°ï¼Œç”¨äºç»Ÿè®¡å’Œæ˜¾ç¤ºè¿›åº¦
        let mut hash_count = 0u64;

        println!("ğŸ”¨ å¼€å§‹æŒ–æ˜åŒºå— #{} (éš¾åº¦: {})...", self.index, self.difficulty);
        println!("ğŸ¯ ç›®æ ‡ï¼šæ‰¾åˆ°ä»¥ '{}' å¼€å¤´çš„å“ˆå¸Œå€¼", target);
        
        // æŒ–çŸ¿ä¸»å¾ªç¯ï¼šä¸æ–­å°è¯•ä¸åŒçš„nonceå€¼
        loop {
            // ä½¿ç”¨å½“å‰nonceå€¼è®¡ç®—å“ˆå¸Œ
            self.hash = self.calculate_hash();
            hash_count += 1;

            // æ¯10000æ¬¡å“ˆå¸Œæ˜¾ç¤ºä¸€æ¬¡è¿›åº¦ï¼Œé¿å…è¾“å‡ºè¿‡äºé¢‘ç¹
            if hash_count % 10000 == 0 {
                // start_time.elapsed() è¿”å›è‡ª start_time ä»¥æ¥çš„æ—¶é—´,
                // as_secs_f64() å°†æ—¶é—´è½¬æ¢ä¸ºç§’æ•°
                let elapsed = start_time.elapsed().as_secs_f64();
                let hash_rate = hash_count as f64 / elapsed;
                // \r è®©å…‰æ ‡å›åˆ°è¡Œé¦–ï¼Œå®ç°åŸåœ°æ›´æ–°è¿›åº¦
                print!("\râ›ï¸  å·²å°è¯• {} æ¬¡å“ˆå¸Œ, é€Ÿç‡: {:.0} H/s", hash_count, hash_rate);
                // å¼ºåˆ¶åˆ·æ–°è¾“å‡ºç¼“å†²åŒºï¼Œç¡®ä¿è¿›åº¦å®æ—¶æ˜¾ç¤º
                std::io::Write::flush(&mut std::io::stdout()).unwrap();
            }

            // æ£€æŸ¥å½“å‰å“ˆå¸Œå€¼æ˜¯å¦æ»¡è¶³éš¾åº¦è¦æ±‚
            if self.hash.starts_with(&target) {
                // æŒ–çŸ¿æˆåŠŸï¼è®¡ç®—ç»Ÿè®¡ä¿¡æ¯
                let elapsed = start_time.elapsed();
                let hash_rate = hash_count as f64 / elapsed.as_secs_f64();
                
                // è¾“å‡ºæŒ–çŸ¿æˆåŠŸä¿¡æ¯
                println!(); // æ¢è¡Œï¼Œé¿å…ä¸è¿›åº¦ä¿¡æ¯é‡å 
                println!("âœ… åŒºå—æŒ–æ˜æˆåŠŸ!");
                println!("ğŸ¯ å“ˆå¸Œå€¼: {}", self.hash);
                println!("ğŸ”¢ Nonce: {}", self.nonce);
                println!("â±ï¸  è€—æ—¶: {:.2}ç§’", elapsed.as_secs_f64());
                println!("ğŸš€ å“ˆå¸Œç‡: {:.0} H/s", hash_rate);
                println!("ğŸ’ æ€»å°è¯•æ¬¡æ•°: {}", hash_count);
                break; // é€€å‡ºæŒ–çŸ¿å¾ªç¯
            }
            
            // å¦‚æœå½“å‰å“ˆå¸Œä¸æ»¡è¶³è¦æ±‚ï¼Œå¢åŠ nonceå€¼ç»§ç»­å°è¯•
            // è¿™é‡Œå¯èƒ½ä¼šæº¢å‡ºï¼Œä½†åœ¨å®é™…åº”ç”¨ä¸­ï¼Œnonceæº¢å‡ºçš„æ¦‚ç‡æä½
            self.nonce += 1;
        }
    }


    /// # éªŒè¯åŒºå—çš„å“ˆå¸Œå€¼æ˜¯å¦æ­£ç¡®
    /// 
    /// æ£€æŸ¥åŒºå—å­˜å‚¨çš„å“ˆå¸Œå€¼æ˜¯å¦ä¸é‡æ–°è®¡ç®—çš„å“ˆå¸Œå€¼ä¸€è‡´ã€‚
    /// è¿™ç”¨äºæ£€æµ‹åŒºå—æ˜¯å¦è¢«ç¯¡æ”¹ã€‚
    /// 
    /// ## éªŒè¯åŸç†
    /// å¦‚æœåŒºå—çš„ä»»ä½•ä¿¡æ¯è¢«ä¿®æ”¹ï¼ˆåŒ…æ‹¬æ•°æ®ã€æ—¶é—´æˆ³ã€nonceç­‰ï¼‰ï¼Œ
    /// é‡æ–°è®¡ç®—çš„å“ˆå¸Œå€¼å°±ä¼šä¸å­˜å‚¨çš„å“ˆå¸Œå€¼ä¸åŒã€‚
    /// 
    /// ## è¿”å›å€¼
    /// - `true`: å“ˆå¸Œå€¼æ­£ç¡®ï¼ŒåŒºå—å®Œæ•´
    /// - `false`: å“ˆå¸Œå€¼ä¸åŒ¹é…ï¼ŒåŒºå—å¯èƒ½è¢«ç¯¡æ”¹
    pub fn is_valid(&self) -> bool {
        self.hash == self.calculate_hash()
    }


    /// # éªŒè¯åŒºå—æ˜¯å¦æ»¡è¶³å·¥ä½œé‡è¯æ˜è¦æ±‚
    /// 
    /// æ£€æŸ¥åŒºå—çš„å“ˆå¸Œå€¼æ˜¯å¦æ»¡è¶³æŒ‡å®šçš„éš¾åº¦è¦æ±‚ã€‚
    /// å³ä½¿å“ˆå¸Œå€¼æ˜¯æ­£ç¡®è®¡ç®—çš„ï¼Œä¹Ÿä¸ä¸€å®šæ»¡è¶³å·¥ä½œé‡è¯æ˜è¦æ±‚ã€‚
    /// 
    /// ## å·¥ä½œé‡è¯æ˜éªŒè¯
    /// æ£€æŸ¥å“ˆå¸Œå€¼æ˜¯å¦ä»¥è¶³å¤Ÿæ•°é‡çš„0å¼€å¤´ï¼š
    /// - éš¾åº¦ä¸º1ï¼šå“ˆå¸Œå€¼éœ€è¦ä»¥"0"å¼€å¤´
    /// - éš¾åº¦ä¸º3ï¼šå“ˆå¸Œå€¼éœ€è¦ä»¥"000"å¼€å¤´
    /// - éš¾åº¦è¶Šé«˜ï¼Œè¦æ±‚çš„å‰å¯¼é›¶è¶Šå¤š
    /// 
    /// ## åº”ç”¨åœºæ™¯
    /// - éªŒè¯æ–°æ¥æ”¶çš„åŒºå—æ˜¯å¦æœ‰æ•ˆ
    /// - æ£€æŸ¥å†å²åŒºå—æ˜¯å¦æ»¡è¶³å½“æ—¶çš„éš¾åº¦è¦æ±‚
    /// 
    /// ## è¿”å›å€¼
    /// - `true`: æ»¡è¶³å·¥ä½œé‡è¯æ˜è¦æ±‚
    /// - `false`: ä¸æ»¡è¶³éš¾åº¦è¦æ±‚ï¼Œå¯èƒ½æ˜¯æ— æ•ˆåŒºå—
    pub fn has_valid_proof_of_work(&self) -> bool {
        // ç”Ÿæˆç›®æ ‡å­—ç¬¦ä¸²ï¼Œä¾‹å¦‚éš¾åº¦ä¸º3åˆ™target="000"
        // String.repeat() ç”Ÿæˆé‡å¤çš„å­—ç¬¦ä¸²
        let target = "0".repeat(self.difficulty as usize);
        // æ£€æŸ¥å½“å‰å“ˆå¸Œå€¼æ˜¯å¦ä»¥è¶³å¤Ÿæ•°é‡çš„0å¼€å¤´
        // String.starts_with() æ£€æŸ¥å­—ç¬¦ä¸²æ˜¯å¦ä»¥æŒ‡å®šå‰ç¼€å¼€å¤´
        self.hash.starts_with(&target)
    }


    /// # è·å–åŒºå—å¤§å°ï¼ˆä¼°ç®—å€¼ï¼‰
    /// 
    /// è®¡ç®—åŒºå—åœ¨å†…å­˜ä¸­å ç”¨çš„å¤§æ¦‚å­—èŠ‚æ•°ã€‚
    /// è¿™ä¸ªå€¼æ˜¯ä¼°ç®—çš„ï¼Œå®é™…åºåˆ—åŒ–åçš„å¤§å°å¯èƒ½ä¸åŒã€‚
    /// 
    /// ## è®¡ç®—æ–¹æ³•
    /// - ç»“æ„ä½“æœ¬èº«çš„å›ºå®šå¤§å°
    /// - åŠ ä¸Šæ‰€æœ‰Stringå­—æ®µçš„é•¿åº¦
    /// 
    /// ## ç”¨é€”
    /// - ç½‘ç»œä¼ è¾“æ—¶ä¼°ç®—å¸¦å®½éœ€æ±‚
    /// - å­˜å‚¨ç©ºé—´è§„åˆ’
    /// - æ€§èƒ½åˆ†æå’Œä¼˜åŒ–
    /// 
    /// ## æ³¨æ„äº‹é¡¹
    /// è¿™åªæ˜¯ä¸€ä¸ªç²—ç•¥çš„ä¼°ç®—ï¼Œå®é™…å¤§å°è¿˜å—åˆ°ï¼š
    /// - å†…å­˜å¯¹é½çš„å½±å“
    /// - åºåˆ—åŒ–æ ¼å¼çš„å½±å“
    /// - å‹ç¼©ç®—æ³•çš„å½±å“
    pub fn get_size(&self) -> usize {

        //stdæ˜¯Rustæ ‡å‡†åº“ï¼Œä½œç”¨æ˜¯æä¾›å†…å­˜å¸ƒå±€ä¿¡æ¯ï¼›memæ˜¯å†…å­˜ï¼Œsize_ofæ˜¯å†…å­˜å¤§å°
        //Selfæ˜¯å½“å‰ç±»å‹ï¼Œsize_of::<Self>()è¿”å›å½“å‰ç±»å‹åœ¨å†…å­˜ä¸­å ç”¨çš„å­—èŠ‚æ•°
        
        // ç»“æ„ä½“å›ºå®šéƒ¨åˆ†çš„å¤§å°
        std::mem::size_of::<Self>() + 
        // æ•°æ®å­—æ®µçš„å­—ç¬¦ä¸²é•¿åº¦
        self.data.len() + 
        // å‰ä¸€åŒºå—å“ˆå¸Œçš„å­—ç¬¦ä¸²é•¿åº¦
        self.previous_hash.len() + 
        // å½“å‰å“ˆå¸Œçš„å­—ç¬¦ä¸²é•¿åº¦ï¼ˆé€šå¸¸æ˜¯64å­—ç¬¦ï¼‰
        self.hash.len()
    }

}


/// # å®ç°Display trait - è‡ªå®šä¹‰æ˜¾ç¤ºæ ¼å¼
/// 
/// ä¸ºBlockå®ç°Display traitï¼Œè®©åŒºå—å¯ä»¥ç”¨println!ç­‰å®å‹å¥½åœ°æ˜¾ç¤ºã€‚
/// ä½¿ç”¨æ ‘çŠ¶ç»“æ„æ˜¾ç¤ºåŒºå—ä¿¡æ¯ï¼Œä¾¿äºé˜…è¯»ã€‚
impl fmt::Display for Block {
    fn fmt(&self, f: &mut fmt::Formatter<'_>) -> fmt::Result {
        write!(
            f,
            "åŒºå— #{}\n\
             â”œâ”€ æ—¶é—´æˆ³: {}\n\
             â”œâ”€ æ•°æ®: {}\n\
             â”œâ”€ å‰ä¸€å“ˆå¸Œ: {}\n\
             â”œâ”€ å“ˆå¸Œå€¼: {}\n\
             â”œâ”€ Nonce: {}\n\
             â”œâ”€ éš¾åº¦: {}\n\
             â””â”€ å¤§å°: {} å­—èŠ‚",
            self.index,
            // æ ¼å¼åŒ–æ—¶é—´æˆ³ä¸ºå¯è¯»æ ¼å¼
            self.timestamp.format("%Y-%m-%d %H:%M:%S UTC"),
            self.data,
            // å¦‚æœå“ˆå¸Œå€¼å¤ªé•¿ï¼Œåªæ˜¾ç¤ºå¼€å¤´å’Œç»“å°¾ï¼Œä¸­é—´ç”¨çœç•¥å·
            if self.previous_hash.len() > 16 {
                format!("{}...{}", &self.previous_hash[..8], &self.previous_hash[self.previous_hash.len()-8..])
            } else {
                self.previous_hash.clone()
            },
            // å“ˆå¸Œå€¼ä¹Ÿåªæ˜¾ç¤ºå¼€å¤´å’Œç»“å°¾
            format!("{}...{}", &self.hash[..8], &self.hash[self.hash.len()-8..]),
            self.nonce,
            self.difficulty,
            self.get_size()
        )
    }
}



// ==================== å•å…ƒæµ‹è¯• ====================
// å•å…ƒæµ‹è¯•ç”¨äºéªŒè¯ä»£ç çš„æ­£ç¡®æ€§ï¼Œç¡®ä¿å„ä¸ªåŠŸèƒ½æ¨¡å—æŒ‰é¢„æœŸå·¥ä½œ

#[cfg(test)]  // åªåœ¨æµ‹è¯•æ—¶ç¼–è¯‘è¿™äº›ä»£ç 
mod tests {
    use super::*;  // å¯¼å…¥ä¸Šçº§æ¨¡å—çš„æ‰€æœ‰å…¬å…±é¡¹

    /// # æµ‹è¯•åˆ›ä¸–åŒºå—çš„åˆ›å»º
    /// 
    /// éªŒè¯åˆ›ä¸–åŒºå—æ˜¯å¦æ­£ç¡®åˆ›å»ºï¼š
    /// - ç´¢å¼•ä¸º0
    /// - å‰ä¸€å“ˆå¸Œä¸º"0"
    /// - å“ˆå¸Œå€¼è®¡ç®—æ­£ç¡®
    #[test]
    fn test_genesis_block_creation() {
        let genesis = Block::genesis_block();
        assert_eq!(genesis.index, 0);
        assert_eq!(genesis.previous_hash, "0");
        assert!(genesis.is_valid());
    }

    /// # æµ‹è¯•åŒºå—å“ˆå¸Œè®¡ç®—çš„ä¸€è‡´æ€§
    /// 
    /// éªŒè¯åŒä¸€ä¸ªåŒºå—å¤šæ¬¡è®¡ç®—å“ˆå¸Œå€¼ç»“æœä¸€è‡´ã€‚
    /// è¿™ç¡®ä¿äº†å“ˆå¸Œå‡½æ•°æ˜¯ç¡®å®šæ€§çš„ã€‚
    #[test]
    fn test_block_hash_calculation() {
        let block = Block::new(1, "test data".to_string(), "prev_hash".to_string(), 1);
        let hash1 = block.calculate_hash();
        let hash2 = block.calculate_hash();
        assert_eq!(hash1, hash2);
    }

    /// # æµ‹è¯•åŒºå—æŒ–çŸ¿åŠŸèƒ½
    /// 
    /// éªŒè¯æŒ–çŸ¿åçš„åŒºå—æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š
    /// - æ»¡è¶³å·¥ä½œé‡è¯æ˜è¦æ±‚
    /// - å“ˆå¸Œå€¼è®¡ç®—æ­£ç¡®
    #[test]
    fn test_block_mining() {
        let mut block = Block::new(1, "test mining".to_string(), "prev_hash".to_string(), 2);
        block.mine_block();
        assert!(block.has_valid_proof_of_work());
        assert!(block.is_valid());
    }

    /// # æµ‹è¯•nonceæ”¹å˜å¯¹å“ˆå¸Œå€¼çš„å½±å“
    /// 
    /// éªŒè¯æ”¹å˜nonceå€¼ä¼šäº§ç”Ÿä¸åŒçš„å“ˆå¸Œå€¼ã€‚
    /// è¿™ç¡®ä¿äº†å“ˆå¸Œå‡½æ•°çš„é›ªå´©æ•ˆåº”ã€‚
    #[test]
    fn test_nonce_increment_changes_hash() {
        let mut block = Block::new(1, "test".to_string(), "prev".to_string(), 1);
        let original_hash = block.calculate_hash();
        block.nonce += 1;  // æ”¹å˜nonceå€¼
        let new_hash = block.calculate_hash();
        assert_ne!(original_hash, new_hash);  // å“ˆå¸Œå€¼åº”è¯¥ä¸åŒ
    }
}